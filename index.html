<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Employee Hours App</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; }
header { background:#262e87; color:white; padding:10px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; position:sticky; top:0; z-index:1001; }
#hamburgerBtn { font-size:24px; cursor:pointer; margin-right:10px; }
#sidebar { width:300px; background:#3a2b7c; color:white; position:fixed; top:0; left:-320px; height:100%; overflow:auto; transition:0.3s; padding:10px; z-index:1002; }
#sidebar.open { left:0; }
#overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); display:none; z-index:1001; }
button { cursor:pointer; margin:2px; padding:4px 8px; border:none; border-radius:4px; background:#f04e23; color:white; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { border:1px solid #333; padding:6px; text-align:center; font-size:0.9em; }
th { background:#f7931e; color:white; position:sticky; top:0; z-index:10; }
input[type=time], input[type=text], input[type=date], select, #filterInput { width:90%; padding:4px; margin:2px 0; }
#savedDatesList li, #masterList li, #masterSiteList li { list-style:none; background:#f04e23; color:white; padding:4px; margin:2px 0; border-radius:3px; cursor:pointer; font-size:0.9em; }
#savedDatesList li:hover, #masterList li:hover, #masterSiteList li:hover { background:#f7931e; }
.employee-item { display:flex; align-items:center; justify-content:flex-start; padding:2px 4px; margin:2px 0; background:#f7931e; border-radius:4px; color:white; font-size:0.9em; }
.employee-item button { margin-right:5px; background:red; color:white; border:none; border-radius:3px; cursor:pointer; }
#overtimeSummary { margin-top:10px; font-weight:bold; color:#262e87; }
#teamCountTableWrapper { margin:20px 10px; }
#teamCountTable { width:100%; border-collapse:collapse; }
#teamCountTable th, #teamCountTable td { border:1px solid #333; padding:6px; text-align:center; font-size:0.9em; }
#teamCountTable th { background:#f7931e; color:white; }
@media(max-width:600px){
  table, th, td, input { font-size:0.8em; }
  header { flex-direction: column; align-items:flex-start; }
  #sidebar { width:260px; }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>

<header>
  <span id="hamburgerBtn">☰ Teams</span>
  <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">
    <input type="date" id="workDate">
    <button id="saveBtn">Save Data</button>
    <button id="exportCSVBtn">Export CSV</button>
    <button id="clearDataBtn">Clear Data</button>
    <button id="shareTeamCountBtn">Share Team Count</button>
    <input type="date" id="exportFrom" title="From Date">
    <input type="date" id="exportTo" title="To Date">
    <input type="text" id="filterInput" placeholder="Filter Employee Name">
  </div>
  <div id="overtimeSummary">Total Overtime: 0 hrs</div>
</header>

<div id="overlay"></div>

<div id="sidebar">
  <h3>Teams & Employees</h3>
  <div id="employeeMenu"></div>
  <h4>Saved Dates</h4>
  <ul id="savedDatesList"></ul>

  <h4>Master Employee List</h4>
  <ul id="masterList"></ul>
  <button onclick="addToMasterList()">➕ Add Employee</button>

  <h4>Master Site List</h4>
  <ul id="masterSiteList"></ul>
  <button onclick="addToMasterSiteList()">➕ Add Site</button>
</div>

<main style="margin-left:10px; padding:10px;">
  <table id="employeeTable"></table>

  <div id="teamCountTableWrapper">
    <h3>Team Count Summary</h3>
    <table id="teamCountTable">
      <tr><th>Date</th><th>Site Name</th><th>Team Count</th><th>OFF Employees</th></tr>
    </table>
  </div>
</main>

<script>
// ==========================
// Global Data
let teams = JSON.parse(localStorage.getItem("teams")) || [
  { name: "Team 1", site:"Site A", siteIn:"", siteOut:"", employees: [] },
  { name: "Team 2", site:"Site B", siteIn:"", siteOut:"", employees: [] },
  { name: "Team 3", site:"Site C", siteIn:"", siteOut:"", employees: [] },
  { name: "Team 4", site:"Site D", siteIn:"", siteOut:"", employees: [] },
  { name: "OFF", site:"OFF", siteIn:"", siteOut:"", employees: [] }
];
let allData = JSON.parse(localStorage.getItem("allData")) || {};
let masterEmployees = JSON.parse(localStorage.getItem("masterEmployees")) || [];
let masterSites = JSON.parse(localStorage.getItem("masterSites")) || [];
let selectedDate = new Date().toISOString().split("T")[0];

function saveTeams(){ localStorage.setItem("teams", JSON.stringify(teams)); }
function saveAllData(){ localStorage.setItem("allData", JSON.stringify(allData)); }
function saveMaster(){ localStorage.setItem("masterEmployees", JSON.stringify(masterEmployees)); }
function saveMasterSites(){ localStorage.setItem("masterSites", JSON.stringify(masterSites)); }

// ==========================
// Date Picker
const dateInput = document.getElementById("workDate");
dateInput.value = selectedDate;
const filterInput = document.getElementById("filterInput");
dateInput.addEventListener("change", ()=>{ selectedDate=dateInput.value; buildEmployeeTable(filterInput.value.trim().toLowerCase()); });

// ==========================
// Sidebar
const sidebar = document.getElementById("sidebar");
const overlay = document.getElementById("overlay");
const hamburgerBtn = document.getElementById("hamburgerBtn");
hamburgerBtn.addEventListener("click", ()=>{ sidebar.classList.add("open"); overlay.style.display="block"; });
overlay.addEventListener("click", ()=>{ sidebar.classList.remove("open"); overlay.style.display="none"; });

// ==========================
// Build Hamburger Menu
function buildHamburgerMenu(){
  const menu=document.getElementById("employeeMenu"); menu.innerHTML="";
  teams.forEach(team=>{
    const teamDiv=document.createElement("div");
    const title=document.createElement("h4"); title.textContent=team.name; teamDiv.appendChild(title);
    if(team.name!=="OFF"){
      const siteInput=document.createElement("select");
      const defaultOpt=document.createElement("option"); defaultOpt.value=""; defaultOpt.text="Select Site"; siteInput.appendChild(defaultOpt);
      masterSites.forEach(siteName=>{ const opt=document.createElement("option"); opt.value=siteName; opt.text=siteName; if(siteName===team.site) opt.selected=true; siteInput.appendChild(opt); });

      const siteInInput=document.createElement("input"); siteInInput.type="time"; siteInInput.value=team.siteIn;
      const siteOutInput=document.createElement("input"); siteOutInput.type="time"; siteOutInput.value=team.siteOut;
      const applyBtn=document.createElement("button"); applyBtn.textContent="Apply to Team"; applyBtn.onclick=()=>{
        team.site=siteInput.value; team.siteIn=siteInInput.value; team.siteOut=siteOutInput.value;
        if(!allData[selectedDate]) allData[selectedDate]={};
        team.employees.forEach(emp=>{
          if(!allData[selectedDate][emp.id]) allData[selectedDate][emp.id]={};
          allData[selectedDate][emp.id].site=team.site;
          allData[selectedDate][emp.id].in=team.siteIn;
          allData[selectedDate][emp.id].out=team.siteOut;
        });
        saveAllData(); buildEmployeeTable(filterInput.value.trim().toLowerCase()); saveTeams(); alert("✅ Applied to all team members");
      };
      const wrap=document.createElement("div"); wrap.innerHTML="<small>Default Site / In / Out:</small><br>";
      wrap.appendChild(siteInput); wrap.appendChild(siteInInput); wrap.appendChild(siteOutInput); wrap.appendChild(applyBtn);
      teamDiv.appendChild(wrap);
    }

    const ul=document.createElement("ul"); ul.dataset.team=team.name;
    team.employees.forEach(emp=>{
      const li=document.createElement("li"); li.className="employee-item";
      const delBtn=document.createElement("button"); delBtn.textContent="❌";
      delBtn.addEventListener("click", (e)=>{ e.stopPropagation(); team.employees = team.employees.filter(e2=>e2.id!==emp.id); saveTeams(); buildHamburgerMenu(); buildEmployeeTable(filterInput.value.trim().toLowerCase()); });
      li.appendChild(delBtn); li.appendChild(document.createTextNode(emp.name+" ("+emp.site+")"));
      li.dataset.empId = emp.id; ul.appendChild(li);
    });
    teamDiv.appendChild(ul);

    // Employee Dropdown
    if(team.name!=="OFF" && masterEmployees.length>0){
      const sel=document.createElement("select");
      const defaultOpt=document.createElement("option"); defaultOpt.value=""; defaultOpt.text="Select Employee"; sel.appendChild(defaultOpt);
      masterEmployees.forEach(name=>{ const opt=document.createElement("option"); opt.value=name; opt.text=name; sel.appendChild(opt); });
      const addBtn=document.createElement("button"); addBtn.textContent="➕ Add Employee";
      addBtn.onclick=()=>{ if(!sel.value) return; const employee={id:Date.now(), name:sel.value, site:team.site, team:team.name}; team.employees.push(employee); saveTeams(); buildHamburgerMenu(); buildEmployeeTable(filterInput.value.trim().toLowerCase()); };
      teamDiv.appendChild(sel); teamDiv.appendChild(addBtn);
    }
    menu.appendChild(teamDiv);
    new Sortable(ul,{group:'employees',animation:150,delay:150,delayOnTouchOnly:true,onEnd: evt=>{
      const empId=evt.item.dataset.empId;
      const newTeamName=evt.to.dataset.team;
      moveEmployeeToTeam(empId,newTeamName);
    }});
  });
  buildMasterList();
  buildMasterSiteList();
}

// ==========================
// Master Employee List
function buildMasterList(){
  const masterList=document.getElementById("masterList"); masterList.innerHTML="";
  masterEmployees.forEach(name=>{
    const li=document.createElement("li"); li.textContent=name;
    const delBtn=document.createElement("button"); delBtn.textContent="❌"; delBtn.onclick=()=>{ masterEmployees=masterEmployees.filter(n=>n!==name); saveMaster(); buildHamburgerMenu(); };
    li.prepend(delBtn); masterList.appendChild(li);
  });
}
function addToMasterList(){
  const name=prompt("Enter employee name to master list:"); if(!name) return;
  if(!masterEmployees.includes(name)){ masterEmployees.push(name); saveMaster(); buildHamburgerMenu(); }
}

// ==========================
// Master Site List
function buildMasterSiteList(){
  const masterSiteList=document.getElementById("masterSiteList"); masterSiteList.innerHTML="";
  masterSites.forEach(site=>{
    const li=document.createElement("li"); li.textContent=site;
    const delBtn=document.createElement("button"); delBtn.textContent="❌"; delBtn.onclick=()=>{ masterSites=masterSites.filter(s=>s!==site); saveMasterSites(); buildHamburgerMenu(); };
    li.prepend(delBtn); masterSiteList.appendChild(li);
  });
}
function addToMasterSiteList(){
  const name=prompt("Enter Site Name:"); if(!name) return;
  if(!masterSites.includes(name)){ masterSites.push(name); saveMasterSites(); buildHamburgerMenu(); }
}

// ==========================
// Move Employee
function moveEmployeeToTeam(empId,newTeamName){
  let emp, oldTeam;
  teams.forEach(team=>team.employees.forEach(e=>{ if(e.id==empId){ emp=e; oldTeam=team; } }));
  if(emp && emp.team!==newTeamName){
    oldTeam.employees = oldTeam.employees.filter(e=>e.id!==empId);
    const newTeam = teams.find(t=>t.name===newTeamName);
    emp.team=newTeamName; newTeam.employees.push(emp);
    saveTeams(); buildHamburgerMenu(); buildEmployeeTable(filterInput.value.trim().toLowerCase());
  }
}

// ==========================
// Table & Overtime
const overtimeSummary = document.getElementById("overtimeSummary");
filterInput.addEventListener("input", ()=>{ buildEmployeeTable(filterInput.value.trim().toLowerCase()); });

function buildEmployeeTable(filterText=""){
  const table=document.getElementById("employeeTable");
  table.innerHTML=`<tr><th>Employee Name</th><th>Date</th><th>Site Name</th><th>Site In</th><th>Site Out</th><th>Total Hours</th><th>Overtime Hours</th></tr>`;
  if(!allData[selectedDate]) allData[selectedDate]={};
  let totalOvertime=0;
  teams.filter(t=>t.name!=="OFF").forEach(team=>team.employees.forEach(emp=>{
    if(filterText && !emp.name.toLowerCase().includes(filterText)) return;
    const row=table.insertRow();
    row.insertCell(0).textContent=emp.name;
    row.insertCell(1).textContent=selectedDate;
    const siteInput=document.createElement("input"); siteInput.value=allData[selectedDate][emp.id]?.site||emp.site;
    row.insertCell(2).appendChild(siteInput);
    const inInput=document.createElement("input"); inInput.type="time"; inInput.value=allData[selectedDate][emp.id]?.in||team.siteIn||"";
    const outInput=document.createElement("input"); outInput.type="time"; outInput.value=allData[selectedDate][emp.id]?.out||team.siteOut||"";
    row.insertCell(3).appendChild(inInput); row.insertCell(4).appendChild(outInput);
    const totalCell=row.insertCell(5); const overtimeCell=row.insertCell(6);
    function updateAndSave(){ 
      const [totalH, overtimeH]=calculateHours(inInput,outInput,totalCell,overtimeCell);
      if(!allData[selectedDate][emp.id]) allData[selectedDate][emp.id]={};
      allData[selectedDate][emp.id].in=inInput.value; allData[selectedDate][emp.id].out=outInput.value;
      allData[selectedDate][emp.id].site=siteInput.value; saveAllData();
      updateOvertimeSummary();
    }
    inInput.addEventListener("change", updateAndSave);
    outInput.addEventListener("change", updateAndSave);
    siteInput.addEventListener("change", updateAndSave);
    const [totalH, overtimeH] = calculateHours(inInput,outInput,totalCell,overtimeCell);
    totalOvertime+=parseFloat(overtimeH);
  }));
  updateOvertimeSummary();
}

function calculateHours(inInput,outInput,totalCell,overtimeCell){
  const inTime=inInput.value, outTime=outInput.value;
  if(!inTime||!outTime){ totalCell.textContent="❌"; overtimeCell.textContent="❌"; totalCell.style.background="red"; overtimeCell.style.background="red"; return [0,0]; }
  totalCell.style.background=""; overtimeCell.style.background="";
  const [inH,inM]=inTime.split(":").map(Number); const [outH,outM]=outTime.split(":").map(Number);
  let diff=(outH*60+outM-(inH*60+inM))/60; if(diff<0) diff+=24; totalCell.textContent=diff.toFixed(2);
  const d=new Date(selectedDate);
  const overtime=(diff>9)?(diff-9):0;
  overtimeCell.textContent=overtime.toFixed(2);
  return [diff,overtime];
}

function updateOvertimeSummary(){ 
  let totalOT=0; 
  const table=document.getElementById("employeeTable"); 
  for(let i=1;i<table.rows.length;i++){ totalOT+=parseFloat(table.rows[i].cells[6].textContent)||0; }
  overtimeSummary.textContent="Total Overtime: "+totalOT.toFixed(2)+" hrs";
}

// ==========================
// Saved Dates List
function updateSavedDatesList(){
  const savedDatesList=document.getElementById("savedDatesList"); savedDatesList.innerHTML="";
  Object.keys(allData).sort((a,b)=>new Date(b)-new Date(a)).forEach(date=>{
    const li=document.createElement("li"); li.textContent=date;
    li.onclick=()=>{ selectedDate=date; dateInput.value=date; buildEmployeeTable(filterInput.value.trim().toLowerCase()); sidebar.classList.remove("open"); overlay.style.display="none"; };
    savedDatesList.appendChild(li);
  });
}

// ==========================
// Export CSV
document.getElementById("exportCSVBtn").addEventListener("click", ()=>{
  const fromDate=document.getElementById("exportFrom").value||selectedDate;
  const toDate=document.getElementById("exportTo").value||selectedDate;
  let rows=[["Employee Name","Date","Site Name","Site In","Site Out","Total Hours","Overtime Hours"]];
  Object.keys(allData).sort().filter(d=>d>=fromDate && d<=toDate).forEach(date=>{
    teams.forEach(team=>team.employees.forEach(emp=>{
      const empData=allData[date]?.[emp.id]; if(!empData) return;
      let total="", overtime="";
      if(empData.in && empData.out){
        const [inH,inM]=empData.in.split(":").map(Number); const [outH,outM]=empData.out.split(":").map(Number);
        let diff=(outH*60+outM-(inH*60+inM))/60; if(diff<0) diff+=24; total=diff.toFixed(2);
        overtime=(diff>9)?(diff-9).toFixed(2):"0";
      }
      rows.push([emp.name,date,empData.site||emp.site,empData.in||"",empData.out||"",total,overtime]);
    }));
  });
  const blob=new Blob([rows.map(r=>r.join(",")).join("\n")],{type:"text/csv"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="employee_hours.csv"; a.click();
});

// ==========================
// Clear Data
document.getElementById("clearDataBtn").addEventListener("click", ()=>{
  if(confirm("Clear all data for "+selectedDate+"?")){ delete allData[selectedDate]; saveAllData(); buildEmployeeTable(); updateTeamCountTable(); updateSavedDatesList(); }
});

// ==========================
// Team Count Table
function updateTeamCountTable(){
  const tbody=document.createElement("tbody");
  tbody.innerHTML="";
  let offTeam = teams.find(t=>t.name==="OFF");
  let offEmployees = offTeam ? offTeam.employees.map(e=>e.name).join(", ") : "";
  let sites = masterSites.length>0 ? masterSites : teams.filter(t=>t.name!=="OFF").map(t=>t.site).filter(s=>s);
  sites.forEach(site=>{
    let count = 0;
    teams.filter(t=>t.name!=="OFF" && t.site===site).forEach(t=>count+=t.employees.length);
    const tr=document.createElement("tr");
    const offForSite = offTeam ? offTeam.employees.filter(e=>allData[selectedDate]?.[e.id]?.site===site).map(e=>e.name).join(", ") : "";
    tr.innerHTML=`<td>${selectedDate}</td><td>${site}</td><td>${count}</td><td>${offForSite}</td>`;
    tbody.appendChild(tr);
  });
  const table=document.getElementById("teamCountTable");
  table.querySelectorAll("tbody").forEach(b=>b.remove());
  table.appendChild(tbody);
}

// ==========================
// Share Team Count
document.getElementById("shareTeamCountBtn").addEventListener("click", ()=>{
  html2canvas(document.getElementById("teamCountTable")).then(canvas=>{
    const dataURL=canvas.toDataURL("image/png");
    const link=document.createElement("a"); link.href=dataURL; link.target="_blank"; link.click();
  });
});

// ==========================
// Save Button
document.getElementById("saveBtn").addEventListener("click", ()=>{
  saveAllData(); updateSavedDatesList(); updateTeamCountTable(); alert("✅ Data saved!");
});

// ==========================
// Initialize
buildHamburgerMenu(); buildEmployeeTable(); updateSavedDatesList(); updateTeamCountTable();
</script>

</body>
</html>
