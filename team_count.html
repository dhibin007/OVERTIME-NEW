<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Team Count View</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; }
header { background:#262e87; color:white; padding:10px; text-align:center; font-size:1.2em; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { border:1px solid #333; padding:8px; text-align:center; font-size:0.9em; }
th { background:#f04e23; color:white; }
tr:nth-child(even) { background:#f9f9f9; }
button { cursor:pointer; margin:5px; padding:6px 12px; border:none; border-radius:4px; background:#f7931e; color:white; font-size:0.9em; }
#captureArea { padding:10px; background:#fff; }
@media(max-width:600px){ table, th, td, button { font-size:0.8em; } }
</style>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>

<header>Team Count View</header>
<div style="padding:10px;">
  <button id="shareBtn">Share Text (WhatsApp)</button>
  <button id="imgBtn">Generate Image</button>

  <div id="captureArea">
    <table id="teamTable">
      <tr>
        <th>Date</th>
        <th>Site Name</th>
        <th>Team Name</th>
        <th>Team Count</th>
      </tr>
    </table>

    <h3>OFF Employees</h3>
    <ul id="offList"></ul>
  </div>
</div>

<script>
// Get date from URL
const params = new URLSearchParams(window.location.search);
const selectedDate = params.get("date");

// Load teams and data
const teams = JSON.parse(localStorage.getItem("teams")) || [];
const allData = JSON.parse(localStorage.getItem("allData")) || {};

// Build table for normal teams
const table = document.getElementById("teamTable");
teams.forEach(team => {
    if(team.name !== "OFF") {
        const hasEmployees = team.employees && team.employees.length > 0;
        const hasSite = team.site && team.site.trim() !== "";
        const hasInOut = (team.siteIn && team.siteIn.trim() !== "") || (team.siteOut && team.siteOut.trim() !== "");

        if(hasEmployees || hasSite || hasInOut) {
            const row = table.insertRow();
            row.insertCell(0).textContent = selectedDate;
            row.insertCell(1).textContent = team.site || "No Site";
            row.insertCell(2).textContent = team.name;
            row.insertCell(3).textContent = team.employees.length;
        }
    }
});

// OFF team employee list
const offList = document.getElementById("offList");
const offTeam = teams.find(t=>t.name==="OFF");
if(offTeam && offTeam.employees.length>0){
    offTeam.employees.forEach(emp=>{
        const li=document.createElement("li");
        li.textContent = emp.name;
        offList.appendChild(li);
    });
} else {
    offList.innerHTML = "<li>No employees marked as OFF</li>";
}

// Share as text
document.getElementById("shareBtn").addEventListener("click", ()=>{
    let msg = `Team Count for ${selectedDate}:\n\n`;
    teams.forEach(team=>{
        if(team.name!=="OFF"){
            const hasEmployees = team.employees && team.employees.length > 0;
            const hasSite = team.site && team.site.trim() !== "";
            const hasInOut = (team.siteIn && team.siteIn.trim() !== "") || (team.siteOut && team.siteOut.trim() !== "");
            if(hasEmployees || hasSite || hasInOut){
                const count = team.employees.length;
                msg += `${team.name} (${team.site || "No Site"}): ${count} members\n`;
            }
        }
    });
    if(offTeam && offTeam.employees.length>0){
        msg += `\nOFF Employees: ${offTeam.employees.map(e=>e.name).join(", ")}`;
    }
    const waLink = "https://wa.me/?text=" + encodeURIComponent(msg);
    window.open(waLink, "_blank");
});

// Generate image of table + OFF list
document.getElementById("imgBtn").addEventListener("click", ()=>{
    const captureArea=document.getElementById("captureArea");
    html2canvas(captureArea).then(canvas=>{
        const imgURL=canvas.toDataURL("image/png");
        const win=window.open();
        win.document.write("<img src='"+imgURL+"' style='max-width:100%'>");
    });
});
</script>

</body>
</html>
